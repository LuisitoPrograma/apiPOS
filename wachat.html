<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Business Web</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #25D366;
      --primary-dark: #128C7E;
      --primary-light: #DCF8C6;
      --background: #E5DDD5;
      --header-bg: #F0F2F5;
      --sidebar-bg: #FFFFFF;
      --text-dark: #3B4A54;
      --text-light: #667781;
      --border-color: #E9EDEF;
      --message-received: #FFFFFF;
      --message-sent: #DCF8C6;
      --online-status: #00BFA5;
      --offline-status: #939FA4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
    }

    body {
      background-color: var(--background);
      height: 100vh;
      display: flex;
    }

    /* App container */
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      max-width: 1400px;
      margin: 0 auto;
      background-color: var(--sidebar-bg);
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 35%;
      min-width: 300px;
      max-width: 400px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      background-color: var(--sidebar-bg);
      transition: transform 0.3s ease;
    }

    /* Header */
    .header {
      padding: 10px 16px;
      background-color: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #DDD;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .header-icons {
      display: flex;
      gap: 20px;
    }

    .header-icon {
      color: var(--text-light);
      font-size: 20px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .header-icon:hover {
      color: var(--primary-dark);
    }

    /* Search */
    .search-container {
      padding: 8px 12px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .search-box {
      display: flex;
      align-items: center;
      background-color: #FFFFFF;
      border-radius: 8px;
      padding: 8px 12px;
    }

    .search-icon {
      color: var(--text-light);
      margin-right: 8px;
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-light);
      position: relative;
    }

    .tab.active {
      color: var(--primary-dark);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
      height: 3px;
      background-color: var(--primary-dark);
      border-radius: 3px 3px 0 0;
    }

    /* Chat list */
    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }

    .chat-item:hover {
      background-color: #F5F5F5;
    }

    .chat-item.active {
      background-color: #EBEBEB;
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #DDD;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      position: relative;
    }

    .online-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      background-color: var(--online-status);
      border-radius: 50%;
      border: 2px solid white;
    }

    .offline-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      background-color: var(--offline-status);
      border-radius: 50%;
      border: 2px solid white;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .chat-name {
      font-weight: 500;
      font-size: 16px;
      color: var(--text-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 12px;
      color: var(--text-light);
    }

    .chat-preview {
      display: flex;
      justify-content: space-between;
    }

    .chat-message {
      font-size: 14px;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .chat-unread {
      background-color: var(--primary-dark);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    /* Main chat area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--background);
      background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
    }

    .chat-header-area {
      padding: 10px 16px;
      background-color: var(--header-bg);
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
    }

    .chat-avatar-area {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #DDD;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      position: relative;
      cursor: pointer;
    }

    .chat-info-area {
      flex: 1;
      cursor: pointer;
    }

    .chat-name-area {
      font-weight: 500;
      font-size: 16px;
      color: var(--text-dark);
    }

    .chat-status {
      font-size: 12px;
      color: var(--text-light);
    }

    .chat-actions {
      display: flex;
      gap: 20px;
    }

    .chat-action-icon {
      color: var(--text-light);
      font-size: 20px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .chat-action-icon:hover {
      color: var(--primary-dark);
    }

    /* Messages */
    .messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.1);
    }

    .message.received {
      background-color: var(--message-received);
      align-self: flex-start;
      margin-left: 10px;
      border-top-left-radius: 0;
    }

    .message.sent {
      background-color: var(--message-sent);
      align-self: flex-end;
      margin-right: 10px;
      border-top-right-radius: 0;
    }

    .message-time {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.45);
      text-align: right;
      margin-top: 4px;
    }

    /* Input area */
    .input-area {
      padding: 8px 16px;
      background-color: var(--header-bg);
      display: flex;
      align-items: center;
      border-top: 1px solid var(--border-color);
    }

    .input-icons {
      display: flex;
      gap: 15px;
      color: var(--text-light);
      font-size: 24px;
    }

    .input-icon {
      cursor: pointer;
      transition: color 0.2s;
    }

    .input-icon:hover {
      color: var(--primary-dark);
    }

    .message-input {
      flex: 1;
      padding: 9px 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      font-size: 15px;
      margin: 0 10px;
      background-color: white;
      transition: box-shadow 0.2s;
    }

    .message-input:focus {
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .send-button {
      background-color: var(--primary-dark);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      transition: background-color 0.2s;
    }

    .send-button:hover {
      background-color: var(--primary-color);
    }

    .send-button:disabled {
      background-color: var(--text-light);
      cursor: not-allowed;
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-light);
      text-align: center;
      padding: 20px;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .empty-text {
      font-size: 16px;
    }

    /* Dropdown menu */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
      min-width: 200px;
      overflow: hidden;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.2s;
    }

    .dropdown-item:hover {
      background-color: #F5F5F5;
    }

    .dropdown-icon {
      width: 20px;
      text-align: center;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      padding: 16px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 600;
      color: var(--text-dark);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-light);
    }

    .modal-body {
      padding: 16px;
    }

    /* Client management */
    .client-management {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .filter-section {
      padding: 16px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .filter-section h3 {
      margin-bottom: 12px;
      font-size: 16px;
      color: var(--text-dark);
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .filter-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 20px;
      transition: background-color 0.2s;
    }

    .filter-options label:hover {
      background-color: #F5F5F5;
    }

    .filter-options input {
      cursor: pointer;
    }

    .client-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .client-item {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }

    .client-item:hover {
      background-color: #F5F5F5;
    }

    .client-info {
      flex: 1;
    }

    .client-info strong {
      font-size: 16px;
      color: var(--text-dark);
      display: block;
      margin-bottom: 4px;
    }

    .client-info small {
      color: var(--text-light);
      font-size: 14px;
    }

    .client-actions {
      display: flex;
      gap: 10px;
    }

    .client-action-btn {
      background: none;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--primary-dark);
      transition: background-color 0.2s;
    }

    .client-action-btn:hover {
      background-color: #F5F5F5;
    }

    /* Add client button */
    .add-client-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: var(--primary-dark);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      z-index: 10;
    }

    .add-client-btn:hover {
      background-color: var(--primary-color);
    }

    /* Group header */
    .group-header {
      padding: 15px 16px 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Bulk message button */
    .bulk-message-btn {
      background-color: var(--primary-dark);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bulk-message-btn:hover {
      background-color: var(--primary-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 10;
      }
      .sidebar.hidden {
        transform: translateX(-100%);
      }
      .chat-area {
        display: none;
      }
      .chat-area.active {
        display: flex;
      }
      .back-button {
        display: block !important;
      }
    }

    .back-button {
      display: none;
      margin-right: 10px;
      font-size: 20px;
      color: var(--text-light);
      cursor: pointer;
    }

    /* Form controls */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--text-dark);
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    .btn-primary {
      background-color: var(--primary-dark);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary:hover {
      background-color: var(--primary-color);
    }

    .btn-secondary {
      background-color: #F0F2F5;
      color: var(--text-dark);
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-secondary:hover {
      background-color: #E5E8EB;
    }

    /* Template modal styles */
    .template-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .message-sender {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="header">
        <div class="user-avatar" id="userAvatar">R</div>
        <div class="header-icons">
          <i class="fas fa-comment-dots header-icon" id="chatTabButton"></i>
          <i class="fas fa-users header-icon" id="clientsTabButton"></i>
          <i class="fas fa-ellipsis-v header-icon" id="menuButton"></i>
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" id="newGroupButton">
            <div class="dropdown-icon"><i class="fas fa-users"></i></div>
            <div>Nuevo grupo</div>
          </div>
          <div class="dropdown-item" id="newContactButton">
            <div class="dropdown-icon"><i class="fas fa-user-plus"></i></div>
            <div>Nuevo contacto</div>
          </div>
          <div class="dropdown-item" id="settingsButton">
            <div class="dropdown-icon"><i class="fas fa-cog"></i></div>
            <div>Configuración</div>
          </div>
          <div class="dropdown-item" id="logoutButton">
            <div class="dropdown-icon"><i class="fas fa-sign-out-alt"></i></div>
            <div>Cerrar sesión</div>
          </div>
          <div class="dropdown-item" id="templateButton">
            <div class="dropdown-icon"><i class="fas fa-file-alt"></i></div>
            <div>Plantillas</div>
          </div>
        </div>
      </div>
      <div class="search-container">
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="searchInput" placeholder="Buscar o empezar nuevo chat">
        </div>
      </div>
      
      <!-- Chats View -->
      <div class="chat-list" id="chatList">
        <!-- Chats will be loaded here -->
      </div>
      
      <!-- Clients View -->
      <div class="client-management" id="clientsView" style="display: none;">
        <div class="filter-section">
          <h3>Filtrar Clientes</h3>
          <div class="filter-options">
            <label><input type="radio" name="filter" value="all" checked> <i class="fas fa-users"></i> Todos</label>
            <label><input type="radio" name="filter" value="mayoristas"> <i class="fas fa-building"></i> Mayoristas</label>
            <label><input type="radio" name="filter" value="minoristas"> <i class="fas fa-user"></i> Minoristas</label>
            <label><input type="radio" name="filter" value="male"> <i class="fas fa-mars"></i> Masculino</label>
            <label><input type="radio" name="filter" value="female"> <i class="fas fa-venus"></i> Femenino</label>
          </div>
        </div>
        <div class="client-list" id="clientList">
          <!-- Clients will be loaded here -->
        </div>
      </div>
    </div>
    
    <!-- Chat area -->
    <div class="chat-area" id="chatArea">
      <div class="chat-header-area">
        <div class="back-button" id="backButton">
          <i class="fas fa-arrow-left"></i>
        </div>
        <div class="chat-avatar-area" id="currentChatAvatar">
          <div class="online-dot" id="onlineDot"></div>
        </div>
        <div class="chat-info-area" id="chatInfoArea">
          <div class="chat-name-area" id="currentChatName">Selecciona un chat</div>
          <div class="chat-status" id="currentChatStatus">en línea</div>
        </div>
        <div class="chat-actions">
          <i class="fas fa-search chat-action-icon" id="chatSearchButton"></i>
          <i class="fas fa-paperclip chat-action-icon" id="attachButton"></i>
          <i class="fas fa-ellipsis-v chat-action-icon" id="chatMenuButton"></i>
        </div>
      </div>
      <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
          <i class="fas fa-comments empty-icon"></i>
          <div class="empty-text">Selecciona un chat para empezar a conversar</div>
        </div>
      </div>
      <div class="input-area">
        <div class="input-icons">
          <i class="far fa-smile input-icon" id="emojiButton"></i>
          <i class="fas fa-plus-circle input-icon" id="moreOptionsButton"></i>
        </div>
        <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje" disabled>
        <button class="send-button" id="sendButton" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Add client button -->
  <button class="add-client-btn" id="addClientBtn">
    <i class="fas fa-plus"></i>
  </button>
  
  <!-- Modals -->
  <div class="modal" id="clientModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Agregar Nuevo Cliente</div>
        <button class="modal-close" id="closeClientModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="clientForm">
          <input type="hidden" id="clientId">
          <div class="form-group">
            <label for="clientName">Nombre:</label>
            <input type="text" class="form-control" id="clientName" required>
          </div>
          <div class="form-group">
            <label for="clientCountryCode">Código de País:</label>
            <input type="text" class="form-control" id="clientCountryCode" required>
          </div>
          <div class="form-group">
            <label for="clientPhone">Número de WhatsApp:</label>
            <input type="text" class="form-control" id="clientPhone" required>
          </div>
          <div class="form-group">
            <label for="clientType">Tipo de Cliente:</label>
            <select class="form-control" id="clientType" required>
              <option value="mayoristas">Mayorista</option>
              <option value="minoristas">Minorista</option>
            </select>
          </div>
          <div class="form-group">
            <label for="clientGender">Sexo:</label>
            <select class="form-control" id="clientGender" required>
              <option value="male">Masculino</option>
              <option value="female">Femenino</option>
            </select>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn-secondary" id="cancelClientBtn">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
<div class="modal" id="bulkMessageModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Enviar Mensaje Masivo</div>
      <button class="modal-close" id="closeBulkMessageModal">&times;</button>
    </div>
    <div class="modal-body">
    <div class="form-group">
  <label for="bulkMessageText">Mensaje:</label>
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <select class="form-control" id="templateSelector" style="flex: 1;">
      <option value="">Seleccionar plantilla...</option>
    </select>
    <button type="button" class="btn-secondary" id="loadTemplateBtn" style="white-space: nowrap;">
      <i class="fas fa-file-alt"></i> Cargar
    </button>
  </div>
  <textarea class="form-control" id="bulkMessageText" rows="4" placeholder="Escribe tu mensaje aquí..." required></textarea>
</div>
      <div class="form-group">
        <label for="bulkMessageGroup">Enviar a:</label>
        <select class="form-control" id="bulkMessageGroup">
          <option value="all">Todos los clientes</option>
          <option value="mayoristas">Solo mayoristas</option>
          <option value="minoristas">Solo minoristas</option>
          <option value="male">Solo hombres</option>
          <option value="female">Solo mujeres</option>
        </select>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="confirmBulkSend"> Confirmo que quiero enviar este mensaje a los clientes seleccionados
        </label>
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-secondary" id="cancelBulkMessage">Cancelar</button>
        <button type="button" class="btn-primary" id="sendBulkMessage" disabled>Enviar</button>
      </div>
    </div>
  </div>
</div>
  <div class="modal" id="newGroupModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Nuevo grupo</div>
        <button class="modal-close" id="closeNewGroupModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="groupForm">
          <div class="form-group">
            <label for="groupName">Nombre del grupo:</label>
            <input type="text" class="form-control" id="groupName" required>
          </div>
          <div class="form-group">
            <label>Seleccionar miembros:</label>
            <div class="member-selection">
              <div id="groupMemberList"></div>
            </div>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn-secondary" id="cancelGroupBtn">Cancelar</button>
            <button type="submit" class="btn-primary">Crear grupo</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal" id="newContactModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Nuevo contacto</div>
        <button class="modal-close" id="closeNewContactModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="contactForm">
          <div class="form-group">
            <label for="contactName">Nombre:</label>
            <input type="text" class="form-control" id="contactName" required>
          </div>
          <div class="form-group">
            <label for="contactPhone">Número de teléfono:</label>
            <input type="text" class="form-control" id="contactPhone" required>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn-secondary" id="cancelContactBtn">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Configuración</div>
        <button class="modal-close" id="closeSettingsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h4>Configuración de la cuenta</h4>
          <div class="form-group">
            <label for="userDisplayName">Nombre para mostrar:</label>
            <input type="text" class="form-control" id="userDisplayName" value="Usuario Demo">
          </div>
          <div class="form-group">
            <label for="userAvatarColor">Color de avatar:</label>
            <input type="color" class="form-control" id="userAvatarColor" value="#25D366">
          </div>
        </div>
        <div class="settings-section">
          <h4>Preferencias</h4>
          <div class="form-group">
            <label>
              <input type="checkbox" id="notificationsEnabled" checked> Notificaciones
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="darkModeEnabled"> Modo oscuro
            </label>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn-secondary" id="cancelSettingsBtn">Cancelar</button>
          <button type="button" class="btn-primary" id="saveSettingsBtn">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal" id="logoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Cerrar sesión</div>
        <button class="modal-close" id="closeLogoutModal">&times;</button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro que deseas cerrar sesión?</p>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
          <button class="btn-secondary" id="cancelLogout">Cancelar</button>
          <button class="btn-primary" id="confirmLogout">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal" id="templateModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <div class="modal-title">Gestionar Plantillas</div>
        <button class="modal-close" id="closeTemplateModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="templateForm">
          <input type="hidden" id="templateId">
          <div class="form-group">
            <label for="templateName">Nombre:</label>
            <input type="text" class="form-control" id="templateName" maxlength="50" required>
          </div>
          <div class="form-group">
            <label for="templateMessage">Mensaje:</label>
            <textarea class="form-control" id="templateMessage" rows="4" maxlength="500" required></textarea>
          </div>
          <div class="form-group">
            <button type="button" id="addVariableBtn" class="btn-secondary">Agregar Variable</button>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn-secondary" id="cancelTemplateBtn">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar</button>
          </div>
        </form>
        
        <div style="margin-top: 30px;">
          <h4 style="font-size: 16px; margin-bottom: 15px;">Plantillas guardadas</h4>
          <input type="text" class="search-input" id="templateSearch" placeholder="Buscar plantillas..." style="width: 100%; margin-bottom: 15px;">
          <div id="templateList" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // =============================================
    // DATA AND STATE MANAGEMENT
    // =============================================
    
    // Sample data
    const user = {
      name: "ronaldinho ",
      avatarText: "R",
      color: "#25D366",
      online: true
    };
    
    // Clientes data
    let clientes = {
      mayoristas: [
        { id: Date.now() + 1, nombre: "Josue Sandoval", codigoPais: "51", numeroWhatsApp: "942360587", sexo: "male" },
        { id: Date.now() + 2, nombre: "Erwin Riofrio", codigoPais: "51", numeroWhatsApp: "947339263", sexo: "male" }
      ],
      minoristas: [
        { id: Date.now() + 3, nombre: "Leonardo Giron", codigoPais: "51", numeroWhatsApp: "920392176", sexo: "male" },
        { id: Date.now() + 4, nombre: "Ronaldinho Pintado", codigoPais: "51", numeroWhatsApp: "916173721", sexo: "male" }
      ],
      grupos: [] // Array para almacenar grupos
    };
    
    // Templates data
    let templates = JSON.parse(localStorage.getItem('whatsappTemplates')) || [];
    let currentTemplateId = null;
    
    // Current state
    let currentChat = null;
    let activeTab = 'chats';
    let isMobileView = window.innerWidth <= 768;
    let messages = {};
    let currentClientId = null;
    let isEditing = false;
    
    // =============================================
    // DOM ELEMENTS
    // =============================================
    
    // Main elements
    const chatList = document.getElementById('chatList');
    const messagesContainer = document.getElementById('messagesContainer');
    const currentChatName = document.getElementById('currentChatName');
    const currentChatAvatar = document.getElementById('currentChatAvatar');
    const currentChatStatus = document.getElementById('currentChatStatus');
    const onlineDot = document.getElementById('onlineDot');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const searchInput = document.getElementById('searchInput');
    const userAvatar = document.getElementById('userAvatar');
    const chatInfoArea = document.getElementById('chatInfoArea');
    
    // Tab buttons
    const chatTabButton = document.getElementById('chatTabButton');
    const clientsTabButton = document.getElementById('clientsTabButton');
    const menuButton = document.getElementById('menuButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    
    // Modal buttons
    const newGroupButton = document.getElementById('newGroupButton');
    const newContactButton = document.getElementById('newContactButton');
    const settingsButton = document.getElementById('settingsButton');
    const logoutButton = document.getElementById('logoutButton');
    const templateButton = document.getElementById('templateButton');
    
    // Modals
    const clientModal = document.getElementById('clientModal');
    const bulkMessageModal = document.getElementById('bulkMessageModal');
    const newGroupModal = document.getElementById('newGroupModal');
    const newContactModal = document.getElementById('newContactModal');
    const settingsModal = document.getElementById('settingsModal');
    const logoutModal = document.getElementById('logoutModal');
    const templateModal = document.getElementById('templateModal');
    
    // Modal close buttons
    const closeClientModal = document.getElementById('closeClientModal');
    const closeBulkMessageModal = document.getElementById('closeBulkMessageModal');
    const closeNewGroupModal = document.getElementById('closeNewGroupModal');
    const closeNewContactModal = document.getElementById('closeNewContactModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const closeLogoutModal = document.getElementById('closeLogoutModal');
    const closeTemplateModal = document.getElementById('closeTemplateModal');
    
    // Form buttons
    const cancelClientBtn = document.getElementById('cancelClientBtn');
    const cancelBulkMessage = document.getElementById('cancelBulkMessage');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');
    const clientsView = document.getElementById('clientsView');
    const clientList = document.getElementById('clientList');
    const backButton = document.getElementById('backButton');
    const chatArea = document.getElementById('chatArea');
    
    // Chat action buttons
    const chatSearchButton = document.getElementById('chatSearchButton');
    const attachButton = document.getElementById('attachButton');
    const chatMenuButton = document.getElementById('chatMenuButton');
    const emojiButton = document.getElementById('emojiButton');
    const moreOptionsButton = document.getElementById('moreOptionsButton');
    const addClientBtn = document.getElementById('addClientBtn');
    
    // Forms
    const clientForm = document.getElementById('clientForm');
    const bulkMessageText = document.getElementById('bulkMessageText');
    const bulkMessageGroup = document.getElementById('bulkMessageGroup');
    const confirmBulkSend = document.getElementById('confirmBulkSend');
    const sendBulkMessage = document.getElementById('sendBulkMessage');
    const groupForm = document.getElementById('groupForm');
    const groupMemberList = document.getElementById('groupMemberList');
    const contactForm = document.getElementById('contactForm');
    const templateForm = document.getElementById('templateForm');
    const templateList = document.getElementById('templateList');
    const templateSearch = document.getElementById('templateSearch');
    const addVariableBtn = document.getElementById('addVariableBtn');
    const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
    const templateSelector = document.getElementById('templateSelector');
    const loadTemplateBtn = document.getElementById('loadTemplateBtn');
    
    // =============================================
    // INITIALIZATION
    // =============================================
    
    // Initialize the app
    function init() {
      renderUserAvatar();
      renderChatList();
      renderClientList();
      setupEventListeners();
      checkMobileView();
      loadSampleMessages();
      renderTemplateList();
    }
    
    // =============================================
    // RENDER FUNCTIONS
    // =============================================
    
    // Render user avatar
    function renderUserAvatar() {
      userAvatar.textContent = user.avatarText;
      userAvatar.style.backgroundColor = user.color;
    }
    
    // Render chat list (from your grouped data)
    function renderChatList(filter = '') {
      chatList.innerHTML = '';
      
      // Render grupos primero
      if (clientes.grupos.length > 0) {
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        groupHeader.textContent = 'Grupos';
        chatList.appendChild(groupHeader);
        
        clientes.grupos.forEach(grupo => {
          const chatElement = createGroupChatElement(grupo);
          chatList.appendChild(chatElement);
        });
      }
      
      // Render mayoristas
      if (clientes.mayoristas.length > 0) {
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        groupHeader.textContent = 'Mayoristas';
        chatList.appendChild(groupHeader);
        
        clientes.mayoristas.forEach(cliente => {
          if (filter === '' || cliente.nombre.toLowerCase().includes(filter.toLowerCase())) {
            const chatElement = createChatElement(cliente);
            chatList.appendChild(chatElement);
          }
        });
      }
      
      // Render minoristas
      if (clientes.minoristas.length > 0) {
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        groupHeader.textContent = 'Minoristas';
        chatList.appendChild(groupHeader);
        
        clientes.minoristas.forEach(cliente => {
          if (filter === '' || cliente.nombre.toLowerCase().includes(filter.toLowerCase())) {
            const chatElement = createChatElement(cliente);
            chatList.appendChild(chatElement);
          }
        });
      }
      
      if (clientes.mayoristas.length === 0 && clientes.minoristas.length === 0 && clientes.grupos.length === 0) {
        chatList.innerHTML = '<div class="empty-state">No hay contactos disponibles</div>';
      }
    }
    
    // Cargar plantillas en el selector
    function loadTemplatesIntoSelector() {
      templateSelector.innerHTML = '<option value="">Seleccionar plantilla...</option>';
      
      templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        templateSelector.appendChild(option);
      });
    }
    
    // Create chat element for individual contact
    function createChatElement(cliente) {
      const chatElement = document.createElement('div');
      chatElement.className = 'chat-item';
      chatElement.dataset.id = cliente.id;
      
      // Get last message
      const lastMessage = messages[cliente.id] && messages[cliente.id].length > 0 
        ? messages[cliente.id][messages[cliente.id].length - 1].text 
        : "Mensaje de prueba";
      
      chatElement.innerHTML = `
        <div class="chat-avatar" style="background-color: ${getAvatarColor(cliente.nombre)}">${getInitials(cliente.nombre)}
          <div class="online-dot"></div>
        </div>
        <div class="chat-info">
          <div class="chat-header">
            <div class="chat-name">${cliente.nombre}</div>
            <div class="chat-time">10:30</div>
          </div>
          <div class="chat-preview">
            <div class="chat-message">${lastMessage}</div>
            <div class="chat-unread">2</div>
          </div>
        </div>
      `;
      
      chatElement.addEventListener('click', () => {
        selectChat(cliente);
        if (isMobileView) {
          chatArea.classList.add('active');
          document.querySelector('.sidebar').classList.add('hidden');
        }
      });
      
      return chatElement;
    }
    
    // Create chat element for group
    function createGroupChatElement(grupo) {
      const chatElement = document.createElement('div');
      chatElement.className = 'chat-item';
      chatElement.dataset.id = grupo.id;
      
      // Get last message
      const lastMessage = messages[grupo.id] && messages[grupo.id].length > 0 
        ? messages[grupo.id][messages[grupo.id].length - 1].text 
        : "Mensaje de prueba";
      
      chatElement.innerHTML = `
        <div class="chat-avatar group-avatar" style="background-color: ${getAvatarColor(grupo.nombre)}">
          <i class="fas fa-users"></i>
        </div>
        <div class="chat-info">
          <div class="chat-header">
            <div class="chat-name">${grupo.nombre}</div>
            <div class="chat-time">10:30</div>
          </div>
          <div class="chat-preview">
            <div class="chat-message">${lastMessage}</div>
            <div class="chat-unread">2</div>
          </div>
        </div>
      `;
      
      chatElement.addEventListener('click', () => {
        selectChat(grupo);
        if (isMobileView) {
          chatArea.classList.add('active');
          document.querySelector('.sidebar').classList.add('hidden');
        }
      });
      
      return chatElement;
    }
    
    // Select chat
    function selectChat(contacto) {
      currentChat = contacto;
      // Update header
      currentChatName.textContent = contacto.nombre;
      
      if (contacto.miembros) {
        // Es un grupo
        currentChatAvatar.innerHTML = '<i class="fas fa-users"></i>';
        currentChatAvatar.style.backgroundColor = getAvatarColor(contacto.nombre);
        currentChatStatus.textContent = `${contacto.miembros.length} miembros`
      } else {
        // Es un contacto individual
        currentChatAvatar.textContent = getInitials(contacto.nombre);
        currentChatAvatar.style.backgroundColor = getAvatarColor(contacto.nombre);
        currentChatStatus.textContent = "en línea";
      }
      
      onlineDot.style.display = 'block';
      // Enable input
      messageInput.disabled = false;
      sendButton.disabled = false;
      messageInput.focus();
      // Render messages
      renderMessages();
      // Mark as active in list
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (parseInt(item.dataset.id) === contacto.id) {
          item.classList.add('active');
        }
      });
    }
    
    // Render messages
    function renderMessages() {
      if (!currentChat || !messages[currentChat.id] || messages[currentChat.id].length === 0) {
        messagesContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-comment-slash empty-icon"></i>
            <div class="empty-text">No hay mensajes en este chat</div>
          </div>
        `;
        return;
      }
      
      messagesContainer.innerHTML = '';
      messages[currentChat.id].forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.type}`;

        // Si es un mensaje de grupo y fue enviado por alguien más, mostrar el nombre
        if (currentChat.miembros && message.type === 'received') {
          messageElement.innerHTML = `
            <div class="message-sender">${message.sender}</div>
            ${message.text}
            <div class="message-time">${formatTime(message.timestamp)}</div>
          `;
        } else {
          messageElement.innerHTML = `
            ${message.text}
            <div class="message-time">${formatTime(message.timestamp)}</div>
          `;
        }
        
        messagesContainer.appendChild(messageElement);
      });
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Render client list (from your code)
    function renderClientList(filter = 'all') {
      clientList.innerHTML = '';
      
      // Add bulk message button
      const bulkButtonContainer = document.createElement('div');
      bulkButtonContainer.style.display = 'flex';
      bulkButtonContainer.style.justifyContent = 'flex-end';
      bulkButtonContainer.style.marginBottom = '20px';
      
      const bulkButton = document.createElement('button');
      bulkButton.className = 'bulk-message-btn';
      bulkButton.innerHTML = '<i class="fas fa-bullhorn"></i> Enviar Mensaje Masivo';
      bulkButton.addEventListener('click', () => {
        bulkMessageModal.classList.add('show');
        loadTemplatesIntoSelector();
      });
      
      bulkButtonContainer.appendChild(bulkButton);
      clientList.appendChild(bulkButtonContainer);
      
      // Get filtered clients
      let todosClientes = [];
      if (filter === 'all') {
        todosClientes = [...clientes.mayoristas, ...clientes.minoristas];
      } else if (filter === 'mayoristas' || filter === 'minoristas') {
        todosClientes = [...clientes[filter]];
      } else {
        // Filter by gender
        todosClientes = [...clientes.mayoristas, ...clientes.minoristas].filter(
          cliente => cliente.sexo === filter
        );
      }
      
      if (todosClientes.length === 0) {
        clientList.innerHTML += '<div class="empty-state">No hay clientes que coincidan con el filtro</div>';
        return;
      }
      
      todosClientes.forEach(cliente => {
        const clientItem = document.createElement('div');
        clientItem.className = 'client-item';
        clientItem.dataset.id = cliente.id;
        clientItem.innerHTML = `
          <div class="client-info">
            <strong>${cliente.nombre}</strong>
            <small>${cliente.codigoPais}${cliente.numeroWhatsApp} - ${getGenderIcon(cliente.sexo)} ${getGenderText(cliente.sexo)}</small>
          </div>
          <div class="client-actions">
            <button class="client-action-btn edit-client" data-id="${cliente.id}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="client-action-btn delete-client" data-id="${cliente.id}" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        clientList.appendChild(clientItem);
      });
      
      // Add event listeners
      document.querySelectorAll('.edit-client').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const clientId = parseInt(e.target.closest('.edit-client').dataset.id);
          editClient(clientId);
        });
      });
      
      document.querySelectorAll('.delete-client').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const clientId = parseInt(e.target.closest('.delete-client').dataset.id);
          deleteClient(clientId);
        });
      });
    }
    
    // Render group member list for group creation
    function renderGroupMemberList() {
      groupMemberList.innerHTML = '';
      
      const allClients = [...clientes.mayoristas, ...clientes.minoristas];
      
      if (allClients.length === 0) {
        groupMemberList.innerHTML = '<p>No hay contactos disponibles para agregar al grupo</p>';
        return;
      }
      
      allClients.forEach(cliente => {
        const memberItem = document.createElement('div');
        memberItem.className = 'member-item';
        memberItem.innerHTML = `
          <label>
            <input type="checkbox" name="groupMembers" value="${cliente.id}">
            ${cliente.nombre} (${cliente.codigoPais}${cliente.numeroWhatsApp})
          </label>
        `;
        groupMemberList.appendChild(memberItem);
      });
    }
    
    // Render template list
    function renderTemplateList(filter = '') {
      templateList.innerHTML = '';
      
      const filteredTemplates = templates.filter(template => 
        template.name.toLowerCase().includes(filter.toLowerCase()) || 
        template.message.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filteredTemplates.length === 0) {
        templateList.innerHTML = '<div class="empty-state">No hay plantillas disponibles</div>';
        return;
      }
      
      filteredTemplates.forEach(template => {
        const templateItem = document.createElement('div');
        templateItem.className = 'template-item';
        templateItem.style.padding = '10px';
        templateItem.style.borderBottom = '1px solid var(--border-color)';
        templateItem.style.display = 'flex';
        templateItem.style.justifyContent = 'space-between';
        templateItem.style.alignItems = 'center';
        
        templateItem.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 500;">${template.name}</div>
            <div style="font-size: 13px; color: var(--text-light);">
              ${template.message.substring(0, 50)}${template.message.length > 50 ? '...' : ''}
            </div>
          </div>
          <div style="display: flex; gap: 5px;">
            <button class="client-action-btn use-template" data-id="${template.id}" title="Usar">
              <i class="fas fa-paper-plane"></i>
            </button>
            <button class="client-action-btn edit-template" data-id="${template.id}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="client-action-btn delete-template" data-id="${template.id}" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        
        templateList.appendChild(templateItem);
      });

      // Agrega eventos a los botones
      document.querySelectorAll('.use-template').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const templateId = parseInt(e.target.closest('.use-template').dataset.id);
          useTemplate(templateId);
        });
      });
      
      document.querySelectorAll('.edit-template').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const templateId = parseInt(e.target.closest('.edit-template').dataset.id);
          editTemplate(templateId);
        });
      });
      
      document.querySelectorAll('.delete-template').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const templateId = parseInt(e.target.closest('.delete-template').dataset.id);
          deleteTemplate(templateId);
        });
      });
    }
    
    // =============================================
    // MESSAGE FUNCTIONS
    // =============================================
    
    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !currentChat) return;
      
      // Add to messages
      if (!messages[currentChat.id]) {
        messages[currentChat.id] = [];
      }
      
      const newMessage = {
        text: text,
        type: 'sent',
        timestamp: new Date()
      };
      
      messages[currentChat.id].push(newMessage);
      
      // Re-render
      renderMessages();
      // Clear input
      messageInput.value = '';
      
      // Send via WhatsApp API
      if (currentChat.miembros) {
        // Es un grupo - enviar a todos los miembros
        currentChat.miembros.forEach(miembro => {
          const numero = `${miembro.codigoPais}${miembro.numeroWhatsApp}@s.whatsapp.net`;
          enviarMensajeWhatsApp(numero, text, miembro.nombre);
        });
      } else {
        // Es un contacto individual
        const numero = `${currentChat.codigoPais}${currentChat.numeroWhatsApp}@s.whatsapp.net`;
        enviarMensajeWhatsApp(numero, text, currentChat.nombre);
      }
    }
    
    // Function to send message via WhatsApp API (from your code)
    async function enviarMensajeWhatsApp(numero, mensaje, nombre) {
      try {
        const response = await fetch('https://apiwachat-1.apierp.dev/wa/3021/send', {
          method: 'POST',
          headers: {
            'x-auth-token': 'HVp5s',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            to: numero,
            payload: {
              type: 'text',
              content: mensaje
            }
          })
        });
        const data = await response.json();
        console.log(`✅ Enviado a ${nombre}:`, data);
        mostrarToast('Mensaje enviado');
      } catch (error) {
        console.error(`❌ Error al enviar a ${nombre}:`, error);
        mostrarToast('Error al enviar mensaje', true);
      }
    }
    
    // Send bulk message
    function sendBulkMessageFunc() {
      const message = bulkMessageText.value.trim();
      if (!message || !confirmBulkSend.checked) return;
      
      const groupFilter = bulkMessageGroup.value;
      let clientsToSend = [];
      
      // Filter clients based on selection
      if (groupFilter === 'all') {
        clientsToSend = [...clientes.mayoristas, ...clientes.minoristas];
      } else if (groupFilter === 'mayoristas' || groupFilter === 'minoristas') {
        clientsToSend = [...clientes[groupFilter]];
      } else {
        clientsToSend = [...clientes.mayoristas, ...clientes.minoristas].filter(
          cliente => cliente.sexo === groupFilter
        );
      }
      
      if (clientsToSend.length === 0) {
        mostrarToast('No hay clientes que coincidan con el filtro seleccionado', true);
        return;
      }
      
      // Send to each client
      clientsToSend.forEach(cliente => {
        let personalizedMessage = message;
        
        // Reemplazar variables en el mensaje
        personalizedMessage = personalizedMessage.replace(/{nombre}/g, cliente.nombre);
        personalizedMessage = personalizedMessage.replace(/{telefono}/g, cliente.numeroWhatsApp);
        personalizedMessage = personalizedMessage.replace(/{tipo}/g, 
          clientes.mayoristas.some(c => c.id === cliente.id) ? 'mayorista' : 'minorista');
        
        const numero = `${cliente.codigoPais}${cliente.numeroWhatsApp}@s.whatsapp.net`;
        enviarMensajeWhatsApp(numero, personalizedMessage, cliente.nombre);
      });
      
      bulkMessageModal.classList.remove('show');
      bulkMessageText.value = '';
      confirmBulkSend.checked = false;
      sendBulkMessage.disabled = true;
      mostrarToast(`Mensaje enviado a ${clientsToSend.length} clientes`);
    }
    
    // =============================================
    // CLIENT MANAGEMENT FUNCTIONS
    // =============================================
    
    // Open client modal
    function openClientModal(editing = false, clientData = null) {
      isEditing = editing;
      if (editing && clientData) {
        document.getElementById('modalTitle').textContent = 'Editar Cliente';
        currentClientId = clientData.id;
        document.getElementById('clientId').value = clientData.id;
        document.getElementById('clientName').value = clientData.nombre;
        document.getElementById('clientCountryCode').value = clientData.codigoPais;
        document.getElementById('clientPhone').value = clientData.numeroWhatsApp;
        document.getElementById('clientType').value = 
          clientes.mayoristas.some(c => c.id === clientData.id) ? 'mayoristas' : 'minoristas';
        document.getElementById('clientGender').value = clientData.sexo || 'male';
      } else {
        document.getElementById('modalTitle').textContent = 'Agregar Nuevo Cliente';
        currentClientId = null;
        clientForm.reset();
      }
      clientModal.classList.add('show');
    }
    
    // Close client modal
    function closeClientModalFunc() {
      clientModal.classList.remove('show');
      clientForm.reset();
      currentClientId = null;
      isEditing = false;
    }
    
    // Edit client
    function editClient(clientId) {
      let clienteEncontrado = null;
      for (const tipo in clientes) {
        const cliente = clientes[tipo].find(c => c.id == clientId);
        if (cliente) {
          clienteEncontrado = cliente;
          break;
        }
      }
      if (clienteEncontrado) {
        openClientModal(true, clienteEncontrado);
      }
    }
    
    // Delete client
    function deleteClient(clientId) {
      if (confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
        // Remove from both categories
        clientes.mayoristas = clientes.mayoristas.filter(c => c.id != clientId);
        clientes.minoristas = clientes.minoristas.filter(c => c.id != clientId);
        
        // Remove from any groups
        clientes.grupos.forEach(grupo => {
          grupo.miembros = grupo.miembros.filter(m => m.id != clientId);
        });
        
        renderClientList(document.querySelector('input[name="filter"]:checked').value);
        renderChatList();
        mostrarToast('Cliente eliminado correctamente');
      }
    }
    
    // Handle client form submit
    function handleClientFormSubmit(e) {
      e.preventDefault();
      const clientData = {
        id: isEditing ? currentClientId : Date.now(),
        nombre: document.getElementById('clientName').value,
        codigoPais: document.getElementById('clientCountryCode').value,
        numeroWhatsApp: document.getElementById('clientPhone').value,
        sexo: document.getElementById('clientGender').value
      };
      const clientType = document.getElementById('clientType').value;
      
      if (isEditing) {
        // Remove from previous category
        clientes.mayoristas = clientes.mayoristas.filter(c => c.id != currentClientId);
        clientes.minoristas = clientes.minoristas.filter(c => c.id != currentClientId);
        
        // Update in groups if exists
        clientes.grupos.forEach(grupo => {
          const miembroIndex = grupo.miembros.findIndex(m => m.id == currentClientId);
          if (miembroIndex !== -1) {
            grupo.miembros[miembroIndex] = clientData;
          }
        });
      }
      
      // Add to new category
      clientes[clientType].push(clientData);
      renderClientList(document.querySelector('input[name="filter"]:checked').value);
      renderChatList();
      closeClientModalFunc();
      mostrarToast(isEditing ? 'Cliente actualizado correctamente' : 'Cliente agregado correctamente');
    }
    
    // =============================================
    // GROUP MANAGEMENT FUNCTIONS
    // =============================================
    
    // Handle group form submit
    function handleGroupFormSubmit(e) {
      e.preventDefault();
      const groupName = document.getElementById('groupName').value;
      const selectedMembers = Array.from(document.querySelectorAll('input[name="groupMembers"]:checked')).map(el => el.value);
      
      if (selectedMembers.length === 0) {
        alert('Debes seleccionar al menos un miembro para el grupo');
        return;
      }
      
      // Get full member data
      const allClients = [...clientes.mayoristas, ...clientes.minoristas];
      const miembros = allClients.filter(cliente => selectedMembers.includes(cliente.id.toString()));
      
      const newGroup = {
        id: Date.now(),
        nombre: groupName,
        miembros: miembros
      };
      
      clientes.grupos.push(newGroup);
      
      // Initialize messages for the group
      messages[newGroup.id] = [
        {
          type: 'system',
          text: `Grupo "${groupName}" creado con ${miembros.length} miembros`,
          timestamp: new Date()
        }
      ];
      
      renderChatList();
      newGroupModal.classList.remove('show');
      groupForm.reset();
      mostrarToast('Grupo creado correctamente');
    }
    
    // =============================================
    // TEMPLATE MANAGEMENT FUNCTIONS
    // =============================================
    
    // Use template
    function useTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (template) {
        messageInput.value = template.message;
        templateModal.classList.remove('show');
        messageInput.focus();
        mostrarToast(`Plantilla "${template.name}" cargada`);
      }
    }
    
    // Edit template
    function editTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (template) {
        currentTemplateId = templateId;
        document.getElementById('templateId').value = template.id;
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateMessage').value = template.message;
        templateModal.classList.add('show');
      }
    }
    
    // Delete template
    function deleteTemplate(templateId) {
      if (confirm('¿Estás seguro de que quieres eliminar esta plantilla?')) {
        templates = templates.filter(t => t.id !== templateId);
        localStorage.setItem('whatsappTemplates', JSON.stringify(templates));
        renderTemplateList(templateSearch.value);
        mostrarToast('Plantilla eliminada');
      }
    }
    
    // Handle template form submit
    function handleTemplateFormSubmit(e) {
      e.preventDefault();
      
      const templateData = {
        id: currentTemplateId || Date.now(),
        name: document.getElementById('templateName').value.trim(),
        message: document.getElementById('templateMessage').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (!templateData.name || !templateData.message) {
        mostrarToast('Nombre y mensaje son requeridos', true);
        return;
      }
      
      if (currentTemplateId) {
        // Editar plantilla existente
        const index = templates.findIndex(t => t.id === currentTemplateId);
        if (index !== -1) {
          templates[index] = templateData;
        }
      } else {
        // Crear nueva plantilla
        templates.unshift(templateData);
      }
      
      localStorage.setItem('whatsappTemplates', JSON.stringify(templates));
      renderTemplateList(templateSearch.value);
      templateForm.reset();
      currentTemplateId = null;
      mostrarToast(`Plantilla ${currentTemplateId ? 'actualizada' : 'guardada'}`);
    }
    
    // Add variable to template
    function addVariable() {
      const variableName = prompt("Ingrese el nombre de la variable (ej: nombre):");
      if (variableName) {
        const textarea = document.getElementById('templateMessage');
        const startPos = textarea.selectionStart;
        const endPos = textarea.selectionEnd;
        const variableText = `{${variableName}}`;
        
        textarea.value = textarea.value.substring(0, startPos) + 
                         variableText + 
                         textarea.value.substring(endPos);
        
        // Coloca el cursor después de la variable insertada
        textarea.focus();
        textarea.selectionStart = startPos + variableText.length;
        textarea.selectionEnd = startPos + variableText.length;
      }
    }
    
    // =============================================
    // OTHER FUNCTIONS
    // =============================================
    
    // Handle contact form submit
    function handleContactFormSubmit(e) {
      e.preventDefault();
      const contactName = document.getElementById('contactName').value;
      const contactPhone = document.getElementById('contactPhone').value;
      
      // Aquí iría la lógica para agregar un nuevo contacto
      // Por ahora solo mostramos un mensaje
      mostrarToast(`Contacto "${contactName}" agregado (simulación)`);
      newContactModal.classList.remove('show');
      contactForm.reset();
    }
    
    // Handle settings save
    function handleSettingsSave() {
      const newName = document.getElementById('userDisplayName').value;
      const newColor = document.getElementById('userAvatarColor').value;
      
      user.name = newName;
      user.avatarText = newName.charAt(0);
      user.color = newColor;
      
      renderUserAvatar();
      settingsModal.classList.remove('show');
      mostrarToast('Configuración guardada');
    }
    
    // Switch tabs
    function switchTab(tab) {
      activeTab = tab;
      // Update UI
      if (tab === 'chats') {
        document.getElementById('chatList').style.display = 'block';
        clientsView.style.display = 'none';
        chatTabButton.style.color = 'var(--primary-dark)';
        clientsTabButton.style.color = 'var(--text-light)';
      } else if (tab === 'clients') {
        document.getElementById('chatList').style.display = 'none';
        clientsView.style.display = 'block';
        chatTabButton.style.color = 'var(--text-light)';
        clientsTabButton.style.color = 'var(--primary-dark)';
        renderClientList(document.querySelector('input[name="filter"]:checked')?.value || 'all');
      }
    }
    
    // Check if mobile view
    function checkMobileView() {
      isMobileView = window.innerWidth <= 768;
      if (isMobileView) {
        chatArea.classList.remove('active');
      } else {
        chatArea.classList.add('active');
      }
    }
    
    // Show toast notification
    function mostrarToast(texto, isError = false) {
      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.bottom = '20px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.backgroundColor = isError ? 'rgba(255, 68, 68, 0.9)' : 'rgba(0, 0, 0, 0.9)';
      toast.style.color = 'white';
      toast.style.padding = '12px 24px';
      toast.style.borderRadius = '4px';
      toast.style.fontSize = '15px';
      toast.style.zIndex = '1000';
      toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      toast.textContent = texto;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // Load sample messages (from your code)
    function loadSampleMessages() {
      // For individual contacts
      [...clientes.mayoristas, ...clientes.minoristas].forEach(cliente => {
        messages[cliente.id] = [
          {
            type: 'received',
            text: 'Hola, ¿cómo estás?',
            timestamp: new Date(Date.now() - 3600000)
          },
          {
            type: 'sent',
            text: 'Hola, bien gracias. ¿Y tú?',
            timestamp: new Date(Date.now() - 1800000)
          }
        ];
      });
      
      // For groups (if any)
      clientes.grupos.forEach(grupo => {
        messages[grupo.id] = [
          {
            type: 'system',
            text: `Grupo "${grupo.nombre}" creado con ${grupo.miembros.length} miembros`,
            timestamp: new Date(Date.now() - 86400000)
          },
          {
            type: 'received',
            text: 'Hola a todos!',
            sender: grupo.miembros[0].nombre,
            timestamp: new Date(Date.now() - 7200000)
          },
          {
            type: 'sent',
            text: 'Bienvenidos al grupo!',
            timestamp: new Date(Date.now() - 3600000)
          }
        ];
      });
    }
    
    // =============================================
    // HELPER FUNCTIONS
    // =============================================
    
    // Helper functions (from your code)
    function getAvatarColor(name) {
      const colors = [
        '#FF5733', '#33FF57', '#3357FF', '#F333FF', 
        '#33FFF3', '#FF33A8', '#A833FF', '#FFC733'
      ];
      const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return colors[hash % colors.length];
    }
    
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('');
    }
    
    function getGenderIcon(gender) {
      return gender === 'male' ? '♂' : gender === 'female' ? '♀' : '⚧';
    }
    
    function getGenderText(gender) {
      return gender === 'male' ? 'Masculino' : gender === 'female' ? 'Femenino' : 'Otro';
    }
    
    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      }) + ' -05';
    }
    
    // =============================================
    // EVENT LISTENERS
    // =============================================
    
    // Setup event listeners
    function setupEventListeners() {
      // Send message on button click
      sendButton.addEventListener('click', sendMessage);
      
      // Send message on Enter key
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Search chats
      searchInput.addEventListener('input', () => {
        renderChatList(searchInput.value);
      });
      
      // Menu button
      menuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
      });
      
      // Cerrar el menú desplegable al hacer clic fuera
      document.addEventListener('click', () => {
        dropdownMenu.classList.remove('show');
      });
      
      // Tab buttons
      chatTabButton.addEventListener('click', () => {
        switchTab('chats');
        dropdownMenu.classList.remove('show');
      });
      
      clientsTabButton.addEventListener('click', () => {
        switchTab('clients');
        dropdownMenu.classList.remove('show');
      });
      
      // Modal buttons
      newGroupButton.addEventListener('click', () => {
        renderGroupMemberList();
        newGroupModal.classList.add('show');
        dropdownMenu.classList.remove('show');
      });
      
      
      newContactButton.addEventListener('click', () => {
        newContactModal.classList.add('show');
        dropdownMenu.classList.remove('show');
      });
      
      settingsButton.addEventListener('click', () => {
        // Cargar la configuración actual
        document.getElementById('bulkMessageBtn').addEventListener('click', () => {
        bulkMessageModal.classList.add('show');
        loadTemplatesIntoSelector(); // Cargar plantillas cuando se abre el modal
      });
        document.getElementById('userDisplayName').value = user.name;
        document.getElementById('userAvatarColor').value = user.color;
        settingsModal.classList.add('show');
        dropdownMenu.classList.remove('show');
      });
      logoutButton.addEventListener('click', () => {
        logoutModal.classList.add('show');
        dropdownMenu.classList.remove('show');
      });
      
      templateButton.addEventListener('click', () => {
        templateModal.classList.add('show');
        dropdownMenu.classList.remove('show');
      });
      
      // Cerrar modales
      closeClientModal.addEventListener('click', closeClientModalFunc);
      closeBulkMessageModal.addEventListener('click', () => {
        bulkMessageModal.classList.remove('show');
      });
      closeNewGroupModal.addEventListener('click', () => {
        newGroupModal.classList.remove('show');
      });
      closeNewContactModal.addEventListener('click', () => {
        newContactModal.classList.remove('show');
      });
      closeSettingsModal.addEventListener('click', () => {
        settingsModal.classList.remove('show');
      });
      closeLogoutModal.addEventListener('click', () => {
        logoutModal.classList.remove('show');
      });
      closeTemplateModal.addEventListener('click', () => {
        templateModal.classList.remove('show');
      });
      
      // Botones cancelar
      cancelClientBtn.addEventListener('click', closeClientModalFunc);
      cancelBulkMessage.addEventListener('click', () => {
        bulkMessageModal.classList.remove('show');
      });
      cancelLogout.addEventListener('click', () => {
        logoutModal.classList.remove('show');
      });
      cancelTemplateBtn.addEventListener('click', () => {
        templateModal.classList.remove('show');
        templateForm.reset();
        currentTemplateId = null;
      });
      
      // Envíos de formularios
      clientForm.addEventListener('submit', handleClientFormSubmit);
      groupForm.addEventListener('submit', handleGroupFormSubmit);
      contactForm.addEventListener('submit', handleContactFormSubmit);
      templateForm.addEventListener('submit', handleTemplateFormSubmit);
      
      // Guardar configuración
      document.getElementById('saveSettingsBtn').addEventListener('click', handleSettingsSave);
      
      // Mensaje masivo
      sendBulkMessage.addEventListener('click', sendBulkMessageFunc);
      confirmBulkSend.addEventListener('change', () => {
        sendBulkMessage.disabled = !confirmBulkSend.checked;
      });
      
      // Botón Atrás en la vista móvil
      backButton.addEventListener('click', () => {
        chatArea.classList.remove('active');
        document.querySelector('.sidebar').classList.remove('hidden');
      });
      
      // Botones de acción del chats
      chatSearchButton.addEventListener('click', () => {
        alert('Funcionalidad de búsqueda en el chat');
      });
      
      attachButton.addEventListener('click', () => {
        alert('Menú de adjuntos aparecería aquí');
      });
      
      chatMenuButton.addEventListener('click', () => {
        alert('Menú de opciones del chat aparecería aquí');
      });
      
      emojiButton.addEventListener('click', () => {
        alert('Selector de emojis aparecería aquí');
      });
      
      moreOptionsButton.addEventListener('click', () => {
        alert('Más opciones aparecerían aquí');
      });
      
      // botón Agregar cliente
      addClientBtn.addEventListener('click', () => openClientModal(false));
      
      // Filtrar clientes
      document.querySelectorAll('input[name="filter"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          renderClientList(e.target.value);
        });
      });
      
      // Búsqueda de plantilla
      templateSearch.addEventListener('input', () => {
        renderTemplateList(templateSearch.value);
      });
      
      // botón Agregar variable
      addVariableBtn.addEventListener('click', addVariable);
      
      // Editar contacto al hacer clic en el encabezado del chat
      currentChatAvatar.addEventListener('click', () => {
        if (currentChat && !currentChat.miembros) {
          editClient(currentChat.id);
        }
      });
      
      chatInfoArea.addEventListener('click', () => {
        if (currentChat && !currentChat.miembros) {
          editClient(currentChat.id);
        }
      });
      
      // Window resize for mobile view
      window.addEventListener('resize', () => {
        checkMobileView();
      });
      
      // Cargar plantillas al abrir el modal de mensajes masivos
      bulkMessageModal.addEventListener('click', () => {
        loadTemplatesIntoSelector();
      });
      
      // Botón para cargar plantilla seleccionada
      loadTemplateBtn.addEventListener('click', () => {
        const templateId = parseInt(templateSelector.value);
        if (!templateId) return;
        
        const template = templates.find(t => t.id === templateId);
        if (template) {
          bulkMessageText.value = template.message;
          mostrarToast(`Plantilla "${template.name}" cargada`);
        }
      });
    }

    // =============================================
    // INITIALIZE THE APP
    // =============================================
    
    init();
  </script>
</body>
</html>